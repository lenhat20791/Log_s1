def add_user_pivot(self, pivot_type, price, time):
    """Thêm pivot từ user với logic mới"""
    try:
        # Kiểm tra loại pivot hợp lệ
        if pivot_type not in ["HH", "HL", "LH", "LL"]:
            save_log(f"❌ Loại pivot không hợp lệ: {pivot_type}", DEBUG_LOG_FILE)
            return False

        # Tạo pivot mới
        new_pivot = {
            "type": pivot_type,
            "price": float(price),
            "time": time
        }

        # Kiểm tra logic với pivot đã có
        recent_pivots = self.get_recent_pivots(4)
        if recent_pivots:
            last_pivot = recent_pivots[0]
            
            # Log thông tin so sánh
            save_log("\n=== Kiểm tra Logic User Pivot ===", DEBUG_LOG_FILE)
            save_log(f"Pivot mới: {pivot_type} tại ${price:,.2f} ({time})", DEBUG_LOG_FILE)
            save_log(f"Pivot trước: {last_pivot['type']} tại ${last_pivot['price']:,.2f} ({last_pivot['time']})", DEBUG_LOG_FILE)

            # Kiểm tra logic
            if not self._validate_pivot_sequence(last_pivot, new_pivot):
                return False

        # Thêm pivot mới vào confirmed_pivots
        if new_pivot not in self.confirmed_pivots:
            self.confirmed_pivots.append(new_pivot)
            save_log(f"✅ Đã thêm pivot: {pivot_type} tại ${price:,.2f} ({time})", DEBUG_LOG_FILE)
            return True

        return False

    except Exception as e:
        save_log(f"❌ Lỗi khi thêm user pivot: {str(e)}", DEBUG_LOG_FILE)
        return False

def _validate_pivot_sequence(self, prev_pivot, new_pivot):
    """Kiểm tra tính hợp lệ của chuỗi pivot"""
    try:
        # HH phải cao hơn pivot trước
        if new_pivot['type'] == 'HH' and new_pivot['price'] <= prev_pivot['price']:
            save_log("❌ HH phải có giá cao hơn pivot trước", DEBUG_LOG_FILE)
            return False
            
        # LL phải thấp hơn pivot trước
        if new_pivot['type'] == 'LL' and new_pivot['price'] >= prev_pivot['price']:
            save_log("❌ LL phải có giá thấp hơn pivot trước", DEBUG_LOG_FILE)
            return False
            
        # LH phải thấp hơn HH trước
        if new_pivot['type'] == 'LH' and prev_pivot['type'] == 'HH' and new_pivot['price'] >= prev_pivot['price']:
            save_log("❌ LH phải có giá thấp hơn HH trước", DEBUG_LOG_FILE)
            return False
            
        # HL phải cao hơn LL trước
        if new_pivot['type'] == 'HL' and prev_pivot['type'] == 'LL' and new_pivot['price'] <= prev_pivot['price']:
            save_log("❌ HL phải có giá cao hơn LL trước", DEBUG_LOG_FILE)
            return False
            
        save_log("✅ Pivot sequence hợp lệ", DEBUG_LOG_FILE)
        return True
            
    except Exception as e:
        save_log(f"❌ Lỗi khi validate pivot sequence: {str(e)}", DEBUG_LOG_FILE)
        return False
